stages:
  - test
  - deploy

variables:
  SSH_PRIVATE_KEY: $SSH_PRIVATE_KEY
  SSH_HOST: $SSH_HOST
  SSH_USER: $SSH_USER
  REMOTE_SCRIPT_PATH: $REMOTE_SCRIPT_PATH
  OPENAI_API_KEY: $OPENAI_API_KEY

cache:
  paths:
    - .venv/

test:
  stage: test
  image: python:3.13-slim
  before_script:
    - python -m venv .venv
    - source .venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - export DISCORD_BOT_TOKEN=test_token
    - export DISCORD_SERVER_ID=test_server_id
    - export DISCORD_BOT_ID=test_bot_id
    - export WEATHERAPI_API_KEY=test_key
    - export CURRENCYAPI_API_KEY=test_key
    - export LOCALTIME_API_KEY=test_key
    - export GOOGLE_API_KEY=test_key
    - export GOOGLE_MAPS_API_KEY=test_key
    - export GEOAPFIY_API_KEY=test_key
    - export ACQIN_API_KEY=test_key
    - export GROQ_API_KEY=test_key
    - export SAMBANOVA_API_KEY=test_key
    - export ENVIRONMENT=testing
    - pytest tests/ -v

deploy:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh docker-cli docker-compose
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $SSH_HOST >> ~/.ssh/known_hosts
  script:
    - ssh $SSH_USER@$SSH_HOST "bash $REMOTE_SCRIPT_PATH"
  only:
    - main
  dependencies:
    - test
